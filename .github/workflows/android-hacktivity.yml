name: üì± Android HackerOne Reports

on:
  workflow_dispatch:  # manual trigger
  schedule:
    - cron: '0 12 * * *'  # runs every day at 12:00 UTC

jobs:
  scrape-android-reports:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Install dependencies
      run: |
        pip install selenium webdriver-manager beautifulsoup4 requests
        pip install -r requirements.txt
        
    - name: Install Chrome
      run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

    - name: üï∑Ô∏è Run Scraper
      run: |
        python scrape.py

    - name: üìä Check if new data was added to SQLite
      id: check_new
      run: |
        if [ -f android_reports.db ]; then
          count=$(sqlite3 android_reports.db "SELECT COUNT(*) FROM reports WHERE date(date) = date('now');")
          echo "New reports today: $count"
          if [ "$count" -gt 0 ]; then
            echo "new_data=true" >> $GITHUB_OUTPUT
            echo "$count" > new-found.flag
          else
            echo "new_data=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "new_data=false" >> $GITHUB_OUTPUT
        fi

    - name: üîî Send Slack Notification
      if: steps.check_new.outputs.new_data == 'true'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        COUNT=$(cat new-found.flag)
        MESSAGE="üì± *$COUNT* new Android vulnerability disclosures found on HackerOne!\n‚û°Ô∏è Check reports: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"$MESSAGE\"}" \
          "$SLACK_WEBHOOK_URL"

    - name: üßπ Clean up
      run: |
        rm -f new-found.flag
